<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>reMarkable Pro Template</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .controls label {
            margin-right: 15px;
            font-weight: bold;
        }
        
        .controls select, .controls button {
            padding: 8px 12px;
            margin-right: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        
        .controls button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .controls button:hover {
            background: #0056b3;
        }
        
        .template-container {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 0 auto;
        }
        
        .template-page {
            width: 1872px;
            height: 1404px;
            background: #f5f5f5;
            position: relative;
            margin: 0 auto;
        }
        
        .border-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }
        
        .content-area {
            position: absolute;
            background: white;
            z-index: 0;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .margin-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 2;
        }
        
        .url-text {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #999;
            font-family: Arial, sans-serif;
            z-index: 3;
            pointer-events: none;
        }
        
        .margin-label-top {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #666;
            font-family: Arial, sans-serif;
            font-weight: bold;
            z-index: 4;
            pointer-events: none;
            display: none;
        }
        
        .margin-label-right {
            position: absolute;
            transform: rotate(-90deg);
            transform-origin: center;
            font-size: 10px;
            color: #666;
            font-family: Arial, sans-serif;
            font-weight: bold;
            z-index: 4;
            pointer-events: none;
            display: none;
            white-space: nowrap;
        }
        
        .ruler-left {
            position: absolute;
            left: 2px;
            top: 0;
            bottom: 0;
            width: 20px;
            font-size: 7px;
            font-family: Arial, sans-serif;
            color: #666;
            z-index: 3;
            pointer-events: none;
            display: none;
        }
        
        .ruler-bottom {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 2px;
            height: 20px;
            font-size: 7px;
            font-family: Arial, sans-serif;
            color: #666;
            z-index: 3;
            pointer-events: none;
            display: none;
        }
        
        .ruler-mark {
            position: absolute;
            white-space: nowrap;
        }
        
        .ruler-left .ruler-mark {
            left: 0;
            transform: translateY(-50%);
        }
        
        .ruler-bottom .ruler-mark {
            bottom: 0;
            transform: translateX(-50%);
        }
        
        .grid-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .lined {
            background-color: white;
        }
        
        .grid {
            background-color: white;
        }
        
        .dot-grid {
            background-color: white;
        }
        
        .blank {
            background: white;
        }
        
        .cornell {
            background: white;
            position: relative;
        }
        
        .cornell::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 150px;
            width: 30%;
            border-right: 2px solid #c0c0c0;
        }
        
        .cornell::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: 150px;
            height: 2px;
            background: #c0c0c0;
        }
        
        .music {
            background-image: repeating-linear-gradient(
                transparent,
                transparent 100px,
                #d0d0d0 100px,
                #d0d0d0 101px,
                transparent 101px,
                transparent 120px,
                #d0d0d0 120px,
                #d0d0d0 121px,
                transparent 121px,
                transparent 140px,
                #d0d0d0 140px,
                #d0d0d0 141px,
                transparent 141px,
                transparent 160px,
                #d0d0d0 160px,
                #d0d0d0 161px,
                transparent 161px,
                transparent 180px,
                #d0d0d0 180px,
                #d0d0d0 181px,
                transparent 181px,
                transparent 250px
            );
        }
        
        @media print {
            body {
                margin: 0;
                padding: 0;
                background: white;
            }
            
            .controls {
                display: none;
            }
            
            .info {
                display: none;
            }
            
            .template-container {
                box-shadow: none;
                margin: 0;
                padding: 0;
            }
            
            .template-page {
                page-break-after: always;
                margin: 0;
            }
            
            .content-area {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            .ruler-left, .ruler-bottom {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        }
        
        .info {
            margin-top: 20px;
            padding: 15px;
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <h2 style="margin: 0 0 5px 0; color: #333; text-align: center; font-style: italic; font-weight: normal;">Rives' reMarkable Book Publishing Template</h2>
        <p style="margin: 0 0 15px 0; color: #666; text-align: center; font-size: 14px;">Suitable for writing on the reMarkable</p>
        
        <div style="margin-bottom: 10px;">
            <label for="deviceType">Device:</label>
            <select id="deviceType">
                <option value="rm2">reMarkable 1/2</option>
                <option value="rmpro" selected>reMarkable Pro</option>
                <option value="paperpromove">Paper Pro Move</option>
            </select>

            <label for="scaleType" style="margin-left: 20px;">Scale:</label>
            <select id="scaleType">
                <option value="yes" selected>Yes</option>
                <option value="no">No</option>
            </select>

            <label for="pageSize" style="margin-left: 20px;">Page Size:</label>
            <select id="pageSize">
                <option value="1620,2160">Full reMarkable Pro (7.07" × 9.43")</option>
            </select>
        </div>
        
        <div style="margin-bottom: 10px;">
            <label for="bindingType">Binding Type:</label>
            <select id="bindingType">
                <option value="perfect">Perfect Binding (Glued)</option>
                <option value="saddle">Saddle Stitch (Stapled)</option>
                <option value="spiral">Spiral/Coil Binding</option>
                <option value="wireo">Wire-O Binding</option>
                <option value="case">Case Binding (Hardcover)</option>
            </select>
            
            <label for="platform" style="margin-left: 20px;">Platform:</label>
            <select id="platform">
                <option value="general">General Publishing</option>
                <option value="kdp">Amazon KDP</option>
                <option value="ingram">IngramSpark</option>
                <option value="lulu">Lulu</option>
                <option value="bn">Barnes & Noble Press</option>
                <option value="d2d">Draft2Digital</option>
                <option value="blurb">Blurb</option>
                <option value="bookbaby">BookBaby</option>
            </select>
            
            <button onclick="applyRecommendedMargins()" style="margin-left: 20px; padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; background: #28a745; color: white; cursor: pointer;">Apply Margin Recommendations</button>
        </div>
        
        <div id="marginRecommendation" style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-left: 4px solid #28a745; border-radius: 4px; font-size: 13px; display: none;">
            <strong>Recommended Margins:</strong> <span id="recommendationText"></span>
        </div>
        
        <div style="margin-bottom: 10px;">
            <label for="marginTop">Margins - Top:</label>
            <select id="marginTop">
                <option value="0">0"</option>
                <option value="11.3">0.05"</option>
                <option value="22.6">0.10"</option>
                <option value="33.9">0.15"</option>
                <option value="45.2">0.20"</option>
                <option value="56.5">0.25"</option>
                <option value="67.8">0.30"</option>
                <option value="79.1">0.35"</option>
                <option value="90.4">0.40"</option>
                <option value="101.7">0.45"</option>
                <option value="113">0.50"</option>
                <option value="124.3">0.55"</option>
                <option value="135.6">0.60"</option>
                <option value="146.9">0.65"</option>
                <option value="158.2">0.70"</option>
                <option value="169.5" selected>0.75"</option>
                <option value="180.8">0.80"</option>
                <option value="192.1">0.85"</option>
                <option value="203.4">0.90"</option>
                <option value="214.7">0.95"</option>
                <option value="226">1.00"</option>
                <option value="237.3">1.05"</option>
                <option value="248.6">1.10"</option>
                <option value="259.9">1.15"</option>
                <option value="271.2">1.20"</option>
                <option value="282.5">1.25"</option>
                <option value="293.8">1.30"</option>
                <option value="305.1">1.35"</option>
                <option value="316.4">1.40"</option>
                <option value="327.7">1.45"</option>
                <option value="339">1.50"</option>
            </select>
            
            <label for="marginBottom" style="margin-left: 10px;">Bottom:</label>
            <select id="marginBottom">
                <option value="0">0"</option>
                <option value="11.3">0.05"</option>
                <option value="22.6">0.10"</option>
                <option value="33.9">0.15"</option>
                <option value="45.2">0.20"</option>
                <option value="56.5">0.25"</option>
                <option value="67.8">0.30"</option>
                <option value="79.1">0.35"</option>
                <option value="90.4">0.40"</option>
                <option value="101.7">0.45"</option>
                <option value="113">0.50"</option>
                <option value="124.3">0.55"</option>
                <option value="135.6">0.60"</option>
                <option value="146.9">0.65"</option>
                <option value="158.2">0.70"</option>
                <option value="169.5" selected>0.75"</option>
                <option value="180.8">0.80"</option>
                <option value="192.1">0.85"</option>
                <option value="203.4">0.90"</option>
                <option value="214.7">0.95"</option>
                <option value="226">1.00"</option>
                <option value="237.3">1.05"</option>
                <option value="248.6">1.10"</option>
                <option value="259.9">1.15"</option>
                <option value="271.2">1.20"</option>
                <option value="282.5">1.25"</option>
                <option value="293.8">1.30"</option>
                <option value="305.1">1.35"</option>
                <option value="316.4">1.40"</option>
                <option value="327.7">1.45"</option>
                <option value="339">1.50"</option>
            </select>
            
            <label for="marginLeft" style="margin-left: 10px;">Left:</label>
            <select id="marginLeft">
                <option value="0">0"</option>
                <option value="11.3">0.05"</option>
                <option value="22.6">0.10"</option>
                <option value="33.9">0.15"</option>
                <option value="45.2">0.20"</option>
                <option value="56.5">0.25"</option>
                <option value="67.8">0.30"</option>
                <option value="79.1">0.35"</option>
                <option value="90.4">0.40"</option>
                <option value="101.7">0.45"</option>
                <option value="113">0.50"</option>
                <option value="124.3">0.55"</option>
                <option value="135.6">0.60"</option>
                <option value="146.9">0.65"</option>
                <option value="158.2">0.70"</option>
                <option value="169.5" selected>0.75"</option>
                <option value="180.8">0.80"</option>
                <option value="192.1">0.85"</option>
                <option value="203.4">0.90"</option>
                <option value="214.7">0.95"</option>
                <option value="226">1.00"</option>
                <option value="237.3">1.05"</option>
                <option value="248.6">1.10"</option>
                <option value="259.9">1.15"</option>
                <option value="271.2">1.20"</option>
                <option value="282.5">1.25"</option>
                <option value="293.8">1.30"</option>
                <option value="305.1">1.35"</option>
                <option value="316.4">1.40"</option>
                <option value="327.7">1.45"</option>
                <option value="339">1.50"</option>
            </select>
            
            <label for="marginRight" style="margin-left: 10px;">Right:</label>
            <select id="marginRight">
                <option value="0">0"</option>
                <option value="11.3">0.05"</option>
                <option value="22.6">0.10"</option>
                <option value="33.9">0.15"</option>
                <option value="45.2">0.20"</option>
                <option value="56.5">0.25"</option>
                <option value="67.8">0.30"</option>
                <option value="79.1">0.35"</option>
                <option value="90.4">0.40"</option>
                <option value="101.7">0.45"</option>
                <option value="113">0.50"</option>
                <option value="124.3">0.55"</option>
                <option value="135.6">0.60"</option>
                <option value="146.9">0.65"</option>
                <option value="158.2">0.70"</option>
                <option value="169.5" selected>0.75"</option>
                <option value="180.8">0.80"</option>
                <option value="192.1">0.85"</option>
                <option value="203.4">0.90"</option>
                <option value="214.7">0.95"</option>
                <option value="226">1.00"</option>
                <option value="237.3">1.05"</option>
                <option value="248.6">1.10"</option>
                <option value="259.9">1.15"</option>
                <option value="271.2">1.20"</option>
                <option value="282.5">1.25"</option>
                <option value="293.8">1.30"</option>
                <option value="305.1">1.35"</option>
                <option value="316.4">1.40"</option>
                <option value="327.7">1.45"</option>
                <option value="339">1.50"</option>
            </select>
            
            <span id="usableArea" style="margin-left: 20px; font-weight: bold; color: #007bff;"></span>
        </div>
        
        <div>
            <label for="templateType">Template Type:</label>
            <select id="templateType">
                <option value="blank">Blank</option>
                <option value="lined">Lined</option>
                <option value="grid" selected>Grid</option>
                <option value="dot-grid">Dot Grid</option>
                <option value="cornell">Cornell Notes</option>
                <option value="music">Music Staff</option>
            </select>

            <label for="gridSize" id="gridSizeLabel" style="margin-left: 20px;">Line/Grid Size:</label>
            <select id="gridSize">
                <option value="11.3">0.05" (11px)</option>
                <option value="22.6" selected>0.10" (23px)</option>
                <option value="33.9">0.15" (34px)</option>
                <option value="45.2">0.20" (45px)</option>
                <option value="56.5">0.25" (57px)</option>
                <option value="67.8">0.30" (68px)</option>
                <option value="79.1">0.35" (79px)</option>
                <option value="90.4">0.40" (90px)</option>
                <option value="101.7">0.45" (102px)</option>
                <option value="113">0.50" (113px)</option>
                <option value="124.3">0.55" (124px)</option>
                <option value="135.6">0.60" (136px)</option>
                <option value="146.9">0.65" (147px)</option>
                <option value="158.2">0.70" (158px)</option>
                <option value="169.5">0.75" (170px)</option>
                <option value="180.8">0.80" (181px)</option>
                <option value="192.1">0.85" (192px)</option>
                <option value="203.4">0.90" (203px)</option>
                <option value="214.7">0.95" (215px)</option>
                <option value="226">1.00" (226px)</option>
                <option value="237.3">1.05" (237px)</option>
                <option value="248.6">1.10" (249px)</option>
                <option value="259.9">1.15" (260px)</option>
                <option value="271.2">1.20" (271px)</option>
                <option value="282.5">1.25" (283px)</option>
            </select>
            
            <label for="overlayGrid" id="overlayGridLabel" style="margin-left: 20px;">Overlay Every:</label>
            <select id="overlayGrid">
                <option value="0">None</option>
                <option value="2">2 squares</option>
                <option value="3">3 squares</option>
                <option value="4">4 squares</option>
                <option value="5" selected>5 squares</option>
                <option value="6">6 squares</option>
                <option value="7">7 squares</option>
                <option value="8">8 squares</option>
                <option value="9">9 squares</option>
                <option value="10">10 squares</option>
            </select>
            
            <label for="showRulers" style="margin-left: 20px;">Show Rulers:</label>
            <input type="checkbox" id="showRulers">
            
            <label for="showMarginDimensions" style="margin-left: 20px;">Show Wd × Ht:</label>
            <input type="checkbox" id="showMarginDimensions">

            <button onclick="printTemplate()">Print/Save as PDF</button>
        </div>

        <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-left: 4px solid #6c757d; border-radius: 4px; font-size: 12px; font-family: monospace;">
            <strong>Debug:</strong> <span id="debugInfo" style="color: #495057;"></span>
        </div>
    </div>
    
    <div class="info">
        <strong>Instructions:</strong> <span style="color: #666; font-size: 12px; margin-left: 10px;">Version 1.0.1</span> 
        <ul style="margin: 10px 0; padding-left: 20px;">
            <li><strong>Device:</strong> Select your reMarkable device. This adjusts the canvas size and available page sizes.</li>
            <li><strong>Scale:</strong> Choose "Yes" for DPI-scaled page sizes or "No" to use the full device screen for the selected page size. When "No" is selected, the entire device canvas represents the physical page dimensions (e.g., selecting "6" × 9"" makes the full device screen represent a 6" × 9" page), no default margins are applied, and rulers/grids scale to match the selected physical dimensions. Scale set to No means that we use the actual tablet size. What you write on it will map to a PDF on export. When Scale is Yes (the default) you are writing the actual size as it will appear in the book.</li>
            <li><strong>Page Size:</strong> Select your target book/page size. Default publishing margins are automatically applied when Scale is "Yes".</li>
            <li><strong>Binding Type & Platform:</strong> View margin recommendations for different binding types and publishing platforms. Click "Apply Recommended Margins" to use suggested defaults.</li>
            <li><strong>Margins:</strong> Adjust individual margins for top, bottom, left, and right (0" to 1.5" in 0.05" increments). Margins are shown with borders (gray for reMarkable 1/2, red for color devices). The usable area (width × height inside margins) is displayed next to the Right margin control.</li>
            <li><strong>Template Type:</strong> Select your preferred template style (lined, grid, dot grid, etc.).</li>
            <li><strong>Line/Grid Size:</strong> For lined, grid, or dot-grid templates, choose the spacing in inches (0.05" to 1.25").</li>
            <li><strong>Overlay Every:</strong> For grid/dot-grid templates, add darker lines/dots every N squares for major/minor grid divisions.</li>
            <li><strong>Show Rulers:</strong> Check this box to display inch measurements along the left and bottom edges (marks every 0.25").</li>
            <li><strong>Show Wd × Ht:</strong> Check this box to display the usable dimensions within the margin areas (width in top margin, height in right margin).</li>
            <li><strong>Export:</strong> Click "Print/Save as PDF" and select "Save as PDF" in the dialog.</li>
        </ul>
        Transfer the PDF to your reMarkable device via the mobile app or desktop software.
    </div>
    
    <div class="template-container">
        <div id="templatePage" class="template-page">
            <div id="borderOverlay" class="border-overlay"></div>
            <div id="marginLabelTop" class="margin-label-top"></div>
            <div id="marginLabelRight" class="margin-label-right"></div>
            <div id="contentArea" class="content-area grid">
                <svg id="gridSvg" class="grid-svg"></svg>
                <div id="urlText" class="url-text">https://srives.github.io/reMarkable/</div>
                <div id="rulerLeft" class="ruler-left"></div>
                <div id="rulerBottom" class="ruler-bottom"></div>
                <div id="marginLines" class="margin-lines"></div>
            </div>
        </div>
    </div>
    
    <script>
        const deviceTypeSelect = document.getElementById('deviceType');
        const scaleTypeSelect = document.getElementById('scaleType');
        const templateTypeSelect = document.getElementById('templateType');
        const pageSizeSelect = document.getElementById('pageSize');
        const bindingTypeSelect = document.getElementById('bindingType');
        const platformSelect = document.getElementById('platform');
        const marginTopSelect = document.getElementById('marginTop');
        const marginBottomSelect = document.getElementById('marginBottom');
        const marginLeftSelect = document.getElementById('marginLeft');
        const marginRightSelect = document.getElementById('marginRight');
        const gridSizeSelect = document.getElementById('gridSize');
        const overlayGridSelect = document.getElementById('overlayGrid');
        const showRulersCheckbox = document.getElementById('showRulers');
        const showMarginDimensionsCheckbox = document.getElementById('showMarginDimensions');
        const gridSizeLabel = document.getElementById('gridSizeLabel');
        const overlayGridLabel = document.getElementById('overlayGridLabel');
        const contentArea = document.getElementById('contentArea');
        const borderOverlay = document.getElementById('borderOverlay');
        const marginLines = document.getElementById('marginLines');
        const templatePage = document.getElementById('templatePage');
        const urlText = document.getElementById('urlText');
        const marginRecommendation = document.getElementById('marginRecommendation');
        const recommendationText = document.getElementById('recommendationText');
        const rulerLeft = document.getElementById('rulerLeft');
        const rulerBottom = document.getElementById('rulerBottom');
        const gridSvg = document.getElementById('gridSvg');
        const usableArea = document.getElementById('usableArea');
        const marginLabelTop = document.getElementById('marginLabelTop');
        const marginLabelRight = document.getElementById('marginLabelRight');
        const debugInfo = document.getElementById('debugInfo');
        
        const devices = {
            rm2: {
                name: 'reMarkable 1/2',
                width: 1404,
                height: 1872,
                dpi: 226,
                unscaledDpi: 226,
                unscaledWidth: 6.25,
                unscaledHeight: 8.25,
                sizes: [
                    { value: '1404,1872', label: 'Full reMarkable 1/2 (6.21" × 8.28")' },
                    { value: '961,1553', label: 'Mass Market Portrait (4.25" × 6.87")' },
                    { value: '1130,1808', label: 'Fiction Portrait (5" × 8")' },
                    { value: '1186,1808', label: 'Fiction Portrait (5.25" × 8")' },
                    { value: '1317,1869', label: 'A5 Portrait (5.83" × 8.27")' },
                    { value: '933,1317', label: 'A6 Portrait (4.13" × 5.83")' },
                    { value: '1146,1763', label: 'UK B-Format Portrait (5.07" × 7.8")' },
                    { value: '1388,2081', label: 'Royal Portrait (6.14" × 9.21")' },
                    { value: '1130,1130', label: 'Square (5" × 5")' },
                    { value: '1356,1356', label: 'Square (6" × 6")' }
                ]
            },
            rmpro: {
                name: 'reMarkable Pro',
                width: 1620,
                height: 2160,
                dpi: 229,
                unscaledDpi: 200,
                unscaledWidth: 7.8,
                unscaledHeight: 10.8,
                sizes: [
                    { value: '1620,2160', label: 'Full reMarkable Pro (7.07" × 9.43")' },
                    { value: '973,1573', label: 'Mass Market Portrait (4.25" × 6.87")' },
                    { value: '1145,1832', label: 'Fiction Portrait (5" × 8")' },
                    { value: '1202,1832', label: 'Fiction Portrait (5.25" × 8")' },
                    { value: '1260,1947', label: 'Digest Portrait (5.5" × 8.5")' },
                    { value: '1374,2061', label: 'US Trade Portrait (6" × 9")' },
                    { value: '1335,1894', label: 'A5 Portrait (5.83" × 8.27")' },
                    { value: '946,1335', label: 'A6 Portrait (4.13" × 5.83")' },
                    { value: '1161,1786', label: 'UK B-Format Portrait (5.07" × 7.8")' },
                    { value: '1406,2109', label: 'Royal Portrait (6.14" × 9.21")' },
                    { value: '1145,1145', label: 'Square (5" × 5")' },
                    { value: '1374,1374', label: 'Square (6" × 6")' },
                    { value: '1603,1603', label: 'Square (7" × 7")' }
                ]
            },
            paperpromove: {
                name: 'Paper Pro Move',
                width: 954,
                height: 1696,
                dpi: 264,
                unscaledDpi: 220,
                unscaledWidth: 4.24,
                unscaledHeight: 7.7,
                sizes: [
                    { value: '953,1695', label: 'Full Paper Pro Move (3.61" × 6.42")' },
                    { value: '792,1122', label: 'Compact (3" × 4.25")' },
                    { value: '792,1320', label: 'Medium (3" × 5")' },
                    { value: '792,1584', label: 'Tall (3" × 6")' }
                ]
            }
        };
        
        const defaultMarginsInches = {
            '1404,1872': { top: 0.6, bottom: 0.65, left: 0.6, right: 0.6 },
            '1620,2160': { top: 0.6, bottom: 0.65, left: 0.65, right: 0.6 },
            '961,1553': { top: 0.4, bottom: 0.45, left: 0.4, right: 0.4 },
            '973,1573': { top: 0.4, bottom: 0.45, left: 0.4, right: 0.4 },
            '1122,1814': { top: 0.35, bottom: 0.4, left: 0.35, right: 0.35 },
            '1130,1808': { top: 0.45, bottom: 0.5, left: 0.45, right: 0.4 },
            '1145,1832': { top: 0.45, bottom: 0.5, left: 0.45, right: 0.4 },
            '1186,1808': { top: 0.45, bottom: 0.5, left: 0.45, right: 0.4 },
            '1202,1832': { top: 0.45, bottom: 0.5, left: 0.45, right: 0.4 },
            '1260,1947': { top: 0.5, bottom: 0.55, left: 0.5, right: 0.45 },
            '1374,2061': { top: 0.55, bottom: 0.6, left: 0.55, right: 0.5 },
            '1317,1869': { top: 0.55, bottom: 0.6, left: 0.5, right: 0.5 },
            '1335,1894': { top: 0.55, bottom: 0.6, left: 0.5, right: 0.5 },
            '933,1317': { top: 0.4, bottom: 0.45, left: 0.4, right: 0.35 },
            '946,1335': { top: 0.4, bottom: 0.45, left: 0.4, right: 0.35 },
            '1146,1763': { top: 0.45, bottom: 0.5, left: 0.45, right: 0.4 },
            '1161,1786': { top: 0.45, bottom: 0.5, left: 0.45, right: 0.4 },
            '1388,2081': { top: 0.55, bottom: 0.6, left: 0.55, right: 0.5 },
            '1406,2109': { top: 0.55, bottom: 0.6, left: 0.55, right: 0.5 },
            '1130,1130': { top: 0.4, bottom: 0.45, left: 0.4, right: 0.4 },
            '1145,1145': { top: 0.4, bottom: 0.45, left: 0.4, right: 0.4 },
            '1356,1356': { top: 0.45, bottom: 0.5, left: 0.45, right: 0.45 },
            '1374,1374': { top: 0.45, bottom: 0.5, left: 0.45, right: 0.45 },
            '1603,1603': { top: 0.5, bottom: 0.55, left: 0.5, right: 0.5 },
            '953,1695': { top: 0.3, bottom: 0.35, left: 0.3, right: 0.3 },
            '792,1122': { top: 0.25, bottom: 0.3, left: 0.25, right: 0.25 },
            '792,1320': { top: 0.25, bottom: 0.3, left: 0.25, right: 0.25 },
            '792,1584': { top: 0.3, bottom: 0.35, left: 0.25, right: 0.25 }
        };
        
        const marginRecommendations = {
            binding: {
                perfect: {
                    name: "Perfect Binding",
                    desc: "Inner/gutter margin should be 0.625\"-0.75\" to account for spine curve. Top: 0.5\"-0.625\", Bottom: 0.625\"-0.75\" (larger than top), Outer: 0.5\"-0.625\"."
                },
                saddle: {
                    name: "Saddle Stitch",
                    desc: "Can use smaller, more equal margins since pages lie flatter. All margins: 0.375\"-0.5\". Inner margin can be slightly smaller than perfect binding."
                },
                spiral: {
                    name: "Spiral/Coil Binding",
                    desc: "Inner margin needs 0.5\"-0.75\" for binding holes. Other margins: 0.375\"-0.5\". Pages lie completely flat."
                },
                wireo: {
                    name: "Wire-O Binding",
                    desc: "Similar to spiral. Inner margin: 0.5\"-0.75\" for wire. Other margins: 0.375\"-0.5\". Pages lay flat and can flip 360°."
                },
                case: {
                    name: "Case Binding (Hardcover)",
                    desc: "More generous margins due to rigid cover. Inner/gutter: 0.75\"-1\", Top: 0.625\"-0.75\", Bottom: 0.75\"-0.875\", Outer: 0.625\"-0.75\"."
                }
            },
            platform: {
                general: {
                    name: "General Publishing",
                    desc: "Standard industry practice: Inner 0.625\"-0.75\", Top 0.5\"-0.625\", Bottom 0.625\"-0.75\", Outer 0.5\"-0.625\". Bottom margin typically largest."
                },
                kdp: {
                    name: "Amazon KDP",
                    desc: "Minimum 0.25\" all sides, but 0.375\"-0.5\" recommended. For books under 150 pages: 0.375\" minimum. 150-400 pages: 0.5\" minimum. Over 400 pages: 0.625\" minimum inner margin."
                },
                ingram: {
                    name: "IngramSpark",
                    desc: "Minimum 0.5\" inside margin required. Recommends: Inside 0.625\"-0.75\", Outside 0.5\", Top 0.5\", Bottom 0.625\". Add 0.125\" per 100 pages for spine thickness."
                },
                lulu: {
                    name: "Lulu",
                    desc: "Minimum 0.25\" all sides. Recommended: Inside 0.625\", Outside 0.5\", Top 0.5\", Bottom 0.625\". For perfect binding, suggest 0.75\" inside margin."
                },
                bn: {
                    name: "Barnes & Noble Press",
                    desc: "Minimum 0.375\" all sides. Recommended: Inside 0.5\"-0.625\", Outside 0.5\", Top 0.5\", Bottom 0.625\". Add more for larger page counts."
                },
                d2d: {
                    name: "Draft2Digital",
                    desc: "Works with multiple print partners. Safe margins: Inside 0.625\", Outside 0.5\", Top 0.5\", Bottom 0.625\". Follows KDP guidelines generally."
                },
                blurb: {
                    name: "Blurb",
                    desc: "Varies by book type. Standard: 0.5\" minimum all sides. Trade books: Inside 0.625\", Outside 0.5\", Top 0.5\", Bottom 0.625\". Photo books can be smaller."
                },
                bookbaby: {
                    name: "BookBaby",
                    desc: "Minimum 0.5\" all sides recommended. Professional standard: Inside 0.75\", Outside 0.5\", Top 0.625\", Bottom 0.75\". More generous for premium appearance."
                }
            }
        };
        
        function updateRecommendation() {
            const binding = marginRecommendations.binding[bindingTypeSelect.value];
            const platform = marginRecommendations.platform[platformSelect.value];
            
            recommendationText.innerHTML = `
                <div style="margin-bottom: 8px;"><strong>${binding.name}:</strong> ${binding.desc}</div>
                <div><strong>${platform.name}:</strong> ${platform.desc}</div>
            `;
            marginRecommendation.style.display = 'block';
        }
        
        function applyRecommendedMargins() {
            applyDefaultMargins();
            updateTemplate();
        }
        
        window.applyRecommendedMargins = applyRecommendedMargins;
        
        function applyDefaultMargins() {
            const device = devices[deviceTypeSelect.value];
            const pageSize = pageSizeSelect.value;
            const marginsInches = defaultMarginsInches[pageSize];
            const isScaled = scaleTypeSelect.value === 'yes';

            // Use appropriate DPI based on scaling mode (matches margin dropdown calculations)
            const dpi = isScaled ? device.dpi : device.unscaledDpi;

            if (marginsInches) {
                const topPx = Math.round(marginsInches.top * dpi * 100) / 100;
                const bottomPx = Math.round(marginsInches.bottom * dpi * 100) / 100;
                const leftPx = Math.round(marginsInches.left * dpi * 100) / 100;
                const rightPx = Math.round(marginsInches.right * dpi * 100) / 100;

                marginTopSelect.value = topPx;
                marginBottomSelect.value = bottomPx;
                marginLeftSelect.value = leftPx;
                marginRightSelect.value = rightPx;
            }
        }
        
        function updateMarginDropdowns() {
            const device = devices[deviceTypeSelect.value];
            const isScaled = scaleTypeSelect.value === 'yes';
            const dpi = isScaled ? device.dpi : device.unscaledDpi;

            const currentTop = marginTopSelect.value;
            const currentBottom = marginBottomSelect.value;
            const currentLeft = marginLeftSelect.value;
            const currentRight = marginRightSelect.value;

            const marginSelects = [marginTopSelect, marginBottomSelect, marginLeftSelect, marginRightSelect];

            marginSelects.forEach(select => {
                select.innerHTML = '';

                for (let inches = 0; inches <= 1.5; inches += 0.05) {
                    const pixels = Math.round(inches * dpi * 100) / 100;
                    const option = document.createElement('option');
                    option.value = pixels;
                    option.textContent = inches.toFixed(2) + '"';
                    select.appendChild(option);
                }
            });

            marginTopSelect.value = currentTop;
            marginBottomSelect.value = currentBottom;
            marginLeftSelect.value = currentLeft;
            marginRightSelect.value = currentRight;
        }
        
        function updatePageSizes() {
            const device = devices[deviceTypeSelect.value];
            const currentValue = pageSizeSelect.value;
            const isScaled = scaleTypeSelect.value === 'yes';
            const dpi = isScaled ? device.dpi : device.unscaledDpi;

            templatePage.style.width = device.width + 'px';
            templatePage.style.height = device.height + 'px';

            updatePrintPageSize(device.width, device.height);
            updateMarginDropdowns();

            pageSizeSelect.innerHTML = '';
            device.sizes.forEach((size, index) => {
                const [width, height] = size.value.split(',').map(Number);
                const option = document.createElement('option');
                option.value = size.value;

                let fits;
                if (width > height) {
                    fits = (width <= device.height && height <= device.width);
                } else {
                    fits = (width <= device.width && height <= device.height);
                }

                if (!fits) {
                    option.textContent = size.label + ' (Too Large)';
                    option.disabled = true;
                    option.style.color = '#999';
                } else {
                    // Only update the first (Full) item when scaling is off
                    if (!isScaled && index === 0) {
                        const baseName = size.label.replace(/\([\d\.]+"\s*×\s*[\d\.]+"\)/, '').trim();
                        option.textContent = `${baseName} (${device.unscaledWidth}" × ${device.unscaledHeight}")`;
                    } else {
                        option.textContent = size.label;
                    }
                }

                pageSizeSelect.appendChild(option);
            });

            const sameIndex = device.sizes.findIndex(s => s.value === currentValue);
            if (sameIndex >= 0) {
                const [width, height] = currentValue.split(',').map(Number);
                let fits;
                if (width > height) {
                    fits = (width <= device.height && height <= device.width);
                } else {
                    fits = (width <= device.width && height <= device.height);
                }
                if (fits) {
                    pageSizeSelect.selectedIndex = sameIndex;
                } else {
                    pageSizeSelect.selectedIndex = 0;
                }
            } else {
                pageSizeSelect.selectedIndex = 0;
            }

            applyDefaultMargins();
            updateTemplate();
        }
        
        function updatePrintPageSize(width, height) {
            const existingStyle = document.getElementById('dynamic-print-style');
            if (existingStyle) {
                existingStyle.remove();
            }
            
            const style = document.createElement('style');
            style.id = 'dynamic-print-style';
            style.textContent = `
                @media print {
                    @page {
                        size: ${width}px ${height}px;
                        margin: 0;
                    }
                    body {
                        width: ${width}px;
                        height: ${height}px;
                    }
                    .template-page {
                        width: ${width}px !important;
                        height: ${height}px !important;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        function printTemplate() {
            const selectedOption = pageSizeSelect.options[pageSizeSelect.selectedIndex];
            const pageLabel = selectedOption.textContent.trim();
            
            const filename = pageLabel
                .replace(/[^\w\s\-\(\)\.]/g, '')
                .replace(/\s+/g, '_')
                .replace(/_{2,}/g, '_');
            
            const originalTitle = document.title;
            document.title = filename;
            
            window.print();
            
            setTimeout(() => {
                document.title = originalTitle;
            }, 1000);
        }
        
        window.printTemplate = printTemplate;
        
        function generateGridSvg(pageWidth, pageHeight, gridSize, overlayMultiplier, templateType, isScaled, pageWidthInInches, pageHeightInInches) {
            gridSvg.innerHTML = '';
            gridSvg.style.display = 'none';

            // When not scaled, recalculate grid size based on physical dimensions
            let actualGridSize = gridSize;
            if (!isScaled) {
                // gridSize is in pixels based on scaled DPI, need to convert to physical inches then to unscaled pixels
                const device = devices[deviceTypeSelect.value];
                const gridSizeInInches = gridSize / device.dpi;
                const pixelsPerInch = pageHeight / pageHeightInInches; // Use height for consistency
                actualGridSize = gridSizeInInches * pixelsPerInch;
            }

            if (templateType === 'grid') {
                gridSvg.style.display = 'block';
                gridSvg.setAttribute('width', pageWidth);
                gridSvg.setAttribute('height', pageHeight);
                gridSvg.setAttribute('viewBox', `0 0 ${pageWidth} ${pageHeight}`);

                const overlaySize = actualGridSize * overlayMultiplier;

                for (let x = actualGridSize; x < pageWidth; x += actualGridSize) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x);
                    line.setAttribute('y1', 0);
                    line.setAttribute('x2', x);
                    line.setAttribute('y2', pageHeight);
                    line.setAttribute('stroke', '#d0d0d0');
                    line.setAttribute('stroke-width', '2');
                    line.setAttribute('shape-rendering', 'crispEdges');
                    gridSvg.appendChild(line);
                }

                for (let y = actualGridSize; y < pageHeight; y += actualGridSize) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', 0);
                    line.setAttribute('y1', y);
                    line.setAttribute('x2', pageWidth);
                    line.setAttribute('y2', y);
                    line.setAttribute('stroke', '#b0b0b0');
                    line.setAttribute('stroke-width', '2');
                    line.setAttribute('shape-rendering', 'crispEdges');
                    gridSvg.appendChild(line);
                }
                
                if (overlayMultiplier > 0) {
                    for (let x = overlaySize; x < pageWidth; x += overlaySize) {
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', x);
                        line.setAttribute('y1', 0);
                        line.setAttribute('x2', x);
                        line.setAttribute('y2', pageHeight);
                        line.setAttribute('stroke', '#b0b0b0');
                        line.setAttribute('stroke-width', '3');
                        line.setAttribute('shape-rendering', 'crispEdges');
                        gridSvg.appendChild(line);
                    }
                    
                    for (let y = overlaySize; y < pageHeight; y += overlaySize) {
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', 0);
                        line.setAttribute('y1', y);
                        line.setAttribute('x2', pageWidth);
                        line.setAttribute('y2', y);
                        line.setAttribute('stroke', '#808080');
                        line.setAttribute('stroke-width', '3');
                        line.setAttribute('shape-rendering', 'crispEdges');
                        gridSvg.appendChild(line);
                    }
                }
            } else if (templateType === 'lined') {
                gridSvg.style.display = 'block';
                gridSvg.setAttribute('width', pageWidth);
                gridSvg.setAttribute('height', pageHeight);
                gridSvg.setAttribute('viewBox', `0 0 ${pageWidth} ${pageHeight}`);

                for (let y = actualGridSize; y < pageHeight; y += actualGridSize) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', 0);
                    line.setAttribute('y1', y);
                    line.setAttribute('x2', pageWidth);
                    line.setAttribute('y2', y);
                    line.setAttribute('stroke', '#d0d0d0');
                    line.setAttribute('stroke-width', '1.5');
                    line.setAttribute('shape-rendering', 'crispEdges');
                    gridSvg.appendChild(line);
                }
            } else if (templateType === 'dot-grid') {
                gridSvg.style.display = 'block';
                gridSvg.setAttribute('width', pageWidth);
                gridSvg.setAttribute('height', pageHeight);
                gridSvg.setAttribute('viewBox', `0 0 ${pageWidth} ${pageHeight}`);

                const overlaySize = actualGridSize * overlayMultiplier;

                for (let x = actualGridSize; x < pageWidth; x += actualGridSize) {
                    for (let y = actualGridSize; y < pageHeight; y += actualGridSize) {
                        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        circle.setAttribute('cx', x);
                        circle.setAttribute('cy', y);
                        circle.setAttribute('r', '2');
                        circle.setAttribute('fill', '#c0c0c0');
                        gridSvg.appendChild(circle);
                    }
                }
                
                if (overlayMultiplier > 0) {
                    for (let x = overlaySize; x < pageWidth; x += overlaySize) {
                        for (let y = overlaySize; y < pageHeight; y += overlaySize) {
                            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                            circle.setAttribute('cx', x);
                            circle.setAttribute('cy', y);
                            circle.setAttribute('r', '3');
                            circle.setAttribute('fill', '#a0a0a0');
                            gridSvg.appendChild(circle);
                        }
                    }
                }
            }
        }
        
        function updateRulers(offsetX = 0, offsetY = 0, selectedPageWidth = null, selectedPageHeight = null) {
            const device = devices[deviceTypeSelect.value];
            const isScaled = scaleTypeSelect.value === 'yes';
            const showRulers = showRulersCheckbox.checked;

            // If not provided, get selectedPageWidth/Height from the dropdown
            if (selectedPageWidth === null || selectedPageHeight === null) {
                [selectedPageWidth, selectedPageHeight] = pageSizeSelect.value.split(',').map(Number);
            }

            // Calculate offset if not provided
            if (isScaled && offsetX === 0 && offsetY === 0) {
                offsetX = (device.width - selectedPageWidth) / 2;
                offsetY = (device.height - selectedPageHeight) / 2;
            }

            // Canvas size is ALWAYS full device dimensions
            let pageWidth = device.width;
            let pageHeight = device.height;

            if (showRulers) {
                rulerLeft.style.display = 'block';
                rulerBottom.style.display = 'block';

                // Rulers are children of contentArea but need to span the FULL device canvas
                // Position left ruler at absolute left edge (x=0) of device
                rulerLeft.style.position = 'absolute';
                rulerLeft.style.left = (-offsetX + 2) + 'px';  // Move to absolute left edge
                rulerLeft.style.top = (-offsetY) + 'px';  // Move to top of device
                rulerLeft.style.height = pageHeight + 'px';

                rulerBottom.style.position = 'absolute';
                rulerBottom.style.left = (-offsetX) + 'px';  // Align with left edge of device
                rulerBottom.style.bottom = 'auto';
                rulerBottom.style.top = (pageHeight - offsetY - 20) + 'px';  // Position at bottom of device
                rulerBottom.style.width = pageWidth + 'px';

                rulerLeft.innerHTML = '';
                rulerBottom.innerHTML = '';

                let widthInInches, heightInInches;

                // Rulers always show FULL DEVICE dimensions (topmost menu option)
                // This is the physical size of the device screen
                let labelToUse = pageSizeSelect.options[0].text;

                const dimensionMatch = labelToUse.match(/\((\d+\.?\d*)"?\s*×\s*(\d+\.?\d*)"?\)/);
                if (dimensionMatch) {
                    widthInInches = parseFloat(dimensionMatch[1]);
                    heightInInches = parseFloat(dimensionMatch[2]);
                } else {
                    // Fallback to device calculation
                    widthInInches = pageWidth / device.dpi;
                    heightInInches = pageHeight / device.dpi;
                }

                // Calculate pixel positions based on FULL DEVICE dimensions
                const pixelsPerInchWidth = pageWidth / widthInInches;
                const pixelsPerInchHeight = pageHeight / heightInInches;

                for (let i = 0.25; i <= heightInInches; i += 0.25) {
                    const mark = document.createElement('div');
                    mark.className = 'ruler-mark';
                    mark.textContent = i.toFixed(2).replace(/\.?0+$/, '') + '"';
                    mark.style.top = (i * pixelsPerInchHeight) + 'px';
                    rulerLeft.appendChild(mark);
                }

                for (let i = 0.25; i <= widthInInches; i += 0.25) {
                    const mark = document.createElement('div');
                    mark.className = 'ruler-mark';
                    mark.textContent = i.toFixed(2).replace(/\.?0+$/, '') + '"';
                    mark.style.left = (i * pixelsPerInchWidth) + 'px';
                    rulerBottom.appendChild(mark);
                }
            } else {
                rulerLeft.style.display = 'none';
                rulerBottom.style.display = 'none';
            }
        }
        
        function updateUsableArea() {
            const device = devices[deviceTypeSelect.value];
            const isScaled = scaleTypeSelect.value === 'yes';

            // Canvas size is ALWAYS full device dimensions
            const pageWidth = device.width;
            const pageHeight = device.height;

            const marginTop = parseFloat(marginTopSelect.value);
            const marginBottom = parseFloat(marginBottomSelect.value);
            const marginLeft = parseFloat(marginLeftSelect.value);
            const marginRight = parseFloat(marginRightSelect.value);

            let pageWidthInInches, pageHeightInInches;

            // ALWAYS use the SELECTED page size for physical dimensions
            const selectedLabel = pageSizeSelect.options[pageSizeSelect.selectedIndex].text;
            const dimensionMatch = selectedLabel.match(/\((\d+\.?\d*)"?\s*×\s*(\d+\.?\d*)"?\)/);
            if (dimensionMatch) {
                pageWidthInInches = parseFloat(dimensionMatch[1]);
                pageHeightInInches = parseFloat(dimensionMatch[2]);
            } else {
                // Fallback to device calculation
                let [selectedPageWidth, selectedPageHeight] = pageSizeSelect.value.split(',').map(Number);
                const actualPageWidth = isScaled ? selectedPageWidth : pageWidth;
                const actualPageHeight = isScaled ? selectedPageHeight : pageHeight;
                pageWidthInInches = actualPageWidth / device.dpi;
                pageHeightInInches = actualPageHeight / device.dpi;
            }

            // Get actual page dimensions for pixel-per-inch calculations
            let [selectedPageWidth, selectedPageHeight] = pageSizeSelect.value.split(',').map(Number);
            const actualPageWidth = isScaled ? selectedPageWidth : pageWidth;
            const actualPageHeight = isScaled ? selectedPageHeight : pageHeight;

            // Calculate pixels per inch
            const pixelsPerInchWidth = actualPageWidth / pageWidthInInches;
            const pixelsPerInchHeight = actualPageHeight / pageHeightInInches;

            // Calculate margin sizes in inches
            const marginTopIn = marginTop / pixelsPerInchHeight;
            const marginBottomIn = marginBottom / pixelsPerInchHeight;
            const marginLeftIn = marginLeft / pixelsPerInchWidth;
            const marginRightIn = marginRight / pixelsPerInchWidth;

            // Calculate usable area in inches
            const usableWidthIn = pageWidthInInches - marginLeftIn - marginRightIn;
            const usableHeightIn = pageHeightInInches - marginTopIn - marginBottomIn;

            // Display the result
            usableArea.textContent = `Usable Area: ${usableWidthIn.toFixed(2)}" × ${usableHeightIn.toFixed(2)}"`;
        }

        function updateDebugInfo() {
            const device = devices[deviceTypeSelect.value];
            const isScaled = scaleTypeSelect.value === 'yes';

            // Canvas size is ALWAYS full device dimensions
            const pageWidth = device.width;
            const pageHeight = device.height;

            let pageWidthInInches, pageHeightInInches;

            // ALWAYS use the SELECTED page size for physical dimensions
            const selectedLabel = pageSizeSelect.options[pageSizeSelect.selectedIndex].text;
            const dimensionMatch = selectedLabel.match(/\((\d+\.?\d*)"?\s*×\s*(\d+\.?\d*)"?\)/);
            if (dimensionMatch) {
                pageWidthInInches = parseFloat(dimensionMatch[1]);
                pageHeightInInches = parseFloat(dimensionMatch[2]);
            } else {
                // Fallback to device calculation
                let [selectedPageWidth, selectedPageHeight] = pageSizeSelect.value.split(',').map(Number);
                const actualPageWidth = isScaled ? selectedPageWidth : pageWidth;
                const actualPageHeight = isScaled ? selectedPageHeight : pageHeight;
                pageWidthInInches = actualPageWidth / device.dpi;
                pageHeightInInches = actualPageHeight / device.dpi;
            }

            // Calculate outer margins (gray centering margins) in inches
            let [selectedPageWidth, selectedPageHeight] = pageSizeSelect.value.split(',').map(Number);
            let offsetX = 0, offsetY = 0;
            if (isScaled) {
                offsetX = (device.width - selectedPageWidth) / 2;
                offsetY = (device.height - selectedPageHeight) / 2;
            }

            // Get full device dimensions in inches for outer margin calculation
            const fullDeviceLabel = pageSizeSelect.options[0].text;
            const fullDeviceDimMatch = fullDeviceLabel.match(/\((\d+\.?\d*)"?\s*×\s*(\d+\.?\d*)"?\)/);
            let fullDeviceWidthIn, fullDeviceHeightIn;
            if (fullDeviceDimMatch) {
                fullDeviceWidthIn = parseFloat(fullDeviceDimMatch[1]);
                fullDeviceHeightIn = parseFloat(fullDeviceDimMatch[2]);
            } else {
                fullDeviceWidthIn = pageWidth / device.dpi;
                fullDeviceHeightIn = pageHeight / device.dpi;
            }

            const outerMarginX = offsetX / (pageWidth / fullDeviceWidthIn);
            const outerMarginY = offsetY / (pageHeight / fullDeviceHeightIn);

            // Calculate user-specified margins in inches
            const marginTop = parseFloat(marginTopSelect.value);
            const marginBottom = parseFloat(marginBottomSelect.value);
            const marginLeft = parseFloat(marginLeftSelect.value);
            const marginRight = parseFloat(marginRightSelect.value);

            const actualPageWidth = isScaled ? selectedPageWidth : pageWidth;
            const actualPageHeight = isScaled ? selectedPageHeight : pageHeight;
            const pixelsPerInchWidth = actualPageWidth / pageWidthInInches;
            const pixelsPerInchHeight = actualPageHeight / pageHeightInInches;

            const marginTopIn = marginTop / pixelsPerInchHeight;
            const marginBottomIn = marginBottom / pixelsPerInchHeight;
            const marginLeftIn = marginLeft / pixelsPerInchWidth;
            const marginRightIn = marginRight / pixelsPerInchWidth;

            // Total margins include outer margins + user-specified margins
            const totalMarginTop = outerMarginY + marginTopIn;
            const totalMarginBottom = outerMarginY + marginBottomIn;
            const totalMarginLeft = outerMarginX + marginLeftIn;
            const totalMarginRight = outerMarginX + marginRightIn;

            debugInfo.textContent = `Canvas: ${pageWidth}×${pageHeight}px | Physical: ${pageWidthInInches.toFixed(2)}"×${pageHeightInInches.toFixed(2)}" | Device Max: ${device.width}×${device.height}px | Outer: ${outerMarginX.toFixed(2)}"×${outerMarginY.toFixed(2)}" | Margins T:${totalMarginTop.toFixed(2)}" B:${totalMarginBottom.toFixed(2)}" L:${totalMarginLeft.toFixed(2)}" R:${totalMarginRight.toFixed(2)}"`;
        }
        
        function updateTemplate() {
            const device = devices[deviceTypeSelect.value];
            const isScaled = scaleTypeSelect.value === 'yes';

            // Canvas/contentArea is ALWAYS full device dimensions
            let pageWidth = device.width;
            let pageHeight = device.height;

            // But we need to know the selected page size for centering and grid drawing
            let selectedPageWidth, selectedPageHeight;
            [selectedPageWidth, selectedPageHeight] = pageSizeSelect.value.split(',').map(Number);

            // Calculate centering offset for gray margins (only when scaled)
            let offsetX = 0, offsetY = 0;
            if (isScaled) {
                offsetX = (device.width - selectedPageWidth) / 2;
                offsetY = (device.height - selectedPageHeight) / 2;
            }

            const marginTop = parseFloat(marginTopSelect.value);
            const marginBottom = parseFloat(marginBottomSelect.value);
            const marginLeft = parseFloat(marginLeftSelect.value);
            const marginRight = parseFloat(marginRightSelect.value);
            const gridSize = parseFloat(gridSizeSelect.value);
            const overlayMultiplier = parseInt(overlayGridSelect.value);
            const templateType = templateTypeSelect.value;

            // Position and size contentArea based on scaling mode
            if (isScaled) {
                // ContentArea is the selected page size, centered in the device canvas
                contentArea.style.width = selectedPageWidth + 'px';
                contentArea.style.height = selectedPageHeight + 'px';
                contentArea.style.left = offsetX + 'px';
                contentArea.style.top = offsetY + 'px';
            } else {
                // ContentArea fills the entire device
                contentArea.style.width = pageWidth + 'px';
                contentArea.style.height = pageHeight + 'px';
                contentArea.style.left = '0px';
                contentArea.style.top = '0px';
            }

            // Gray centering margins (only when scaled and page size < device size)
            if (offsetX > 0 || offsetY > 0) {
                borderOverlay.style.boxShadow = `
                    inset ${offsetX}px 0 0 rgba(0,0,0,0.15),
                    inset -${offsetX}px 0 0 rgba(0,0,0,0.15),
                    inset 0 ${offsetY}px 0 rgba(0,0,0,0.15),
                    inset 0 -${offsetY}px 0 rgba(0,0,0,0.15)
                `;
            } else {
                borderOverlay.style.boxShadow = 'none';
            }
            
            contentArea.className = 'content-area ' + templateType;

            if (templateType === 'lined' || templateType === 'grid' || templateType === 'dot-grid') {
                gridSizeSelect.style.display = 'inline-block';
                gridSizeLabel.style.display = 'inline';
            } else {
                gridSizeSelect.style.display = 'none';
                gridSizeLabel.style.display = 'none';
            }

            if (templateType === 'grid' || templateType === 'dot-grid') {
                overlayGridSelect.style.display = 'inline-block';
                overlayGridLabel.style.display = 'inline';
            } else {
                overlayGridSelect.style.display = 'none';
                overlayGridLabel.style.display = 'none';
            }

            // Calculate physical dimensions for grid scaling and margin labels
            let pageWidthInInches, pageHeightInInches;

            // ALWAYS use the SELECTED page size for physical dimensions
            // This is the actual page being created (e.g., 6" × 9")
            const selectedLabel = pageSizeSelect.options[pageSizeSelect.selectedIndex].text;
            const dimensionMatch = selectedLabel.match(/\((\d+\.?\d*)"?\s*×\s*(\d+\.?\d*)"?\)/);
            if (dimensionMatch) {
                pageWidthInInches = parseFloat(dimensionMatch[1]);
                pageHeightInInches = parseFloat(dimensionMatch[2]);
            } else {
                // Fallback to device calculation
                const actualPageWidth = isScaled ? selectedPageWidth : pageWidth;
                const actualPageHeight = isScaled ? selectedPageHeight : pageHeight;
                pageWidthInInches = actualPageWidth / device.dpi;
                pageHeightInInches = actualPageHeight / device.dpi;
            }

            // Grid and marginLines are positioned relative to contentArea
            // They should fill contentArea and let the borders define the pink margins
            gridSvg.style.left = '0px';
            gridSvg.style.top = '0px';
            gridSvg.style.width = '100%';
            gridSvg.style.height = '100%';

            // Generate grid with the appropriate dimensions
            if (isScaled) {
                generateGridSvg(selectedPageWidth, selectedPageHeight, gridSize, overlayMultiplier, templateType, isScaled, pageWidthInInches, pageHeightInInches);
            } else {
                generateGridSvg(pageWidth, pageHeight, gridSize, overlayMultiplier, templateType, isScaled, pageWidthInInches, pageHeightInInches);
            }

            // User-specified pinkish margins (borders on marginLines element)
            // marginLines fills contentArea using the CSS top/left/right/bottom: 0
            // Don't set width/height as that conflicts with right/bottom and causes overflow
            marginLines.style.boxSizing = 'border-box';

            if (marginTop > 0 || marginBottom > 0 || marginLeft > 0 || marginRight > 0) {
                marginLines.style.borderTopWidth = marginTop + 'px';
                marginLines.style.borderBottomWidth = marginBottom + 'px';
                marginLines.style.borderLeftWidth = marginLeft + 'px';
                marginLines.style.borderRightWidth = marginRight + 'px';
                marginLines.style.borderStyle = 'solid';

                if (deviceTypeSelect.value === 'rm2') {
                    marginLines.style.borderColor = 'rgba(100, 100, 100, 0.4)';
                } else {
                    marginLines.style.borderColor = 'rgba(255, 100, 100, 0.3)';
                }

                marginLines.style.display = 'block';
            } else {
                marginLines.style.display = 'none';
            }
            
            // Position URL text in the top margin area (relative to contentArea)
            if (marginTop >= 15) {
                urlText.style.display = 'block';
                urlText.style.top = '5px';
                urlText.style.left = '50%';
            } else {
                urlText.style.display = 'none';
            }

            // Calculate physical dimensions and margins
            const actualPageWidth = isScaled ? selectedPageWidth : pageWidth;
            const actualPageHeight = isScaled ? selectedPageHeight : pageHeight;

            // Calculate pixels per inch
            const pixelsPerInchWidth = actualPageWidth / pageWidthInInches;
            const pixelsPerInchHeight = actualPageHeight / pageHeightInInches;

            // Calculate margin sizes in inches
            const marginTopIn = marginTop / pixelsPerInchHeight;
            const marginBottomIn = marginBottom / pixelsPerInchHeight;
            const marginLeftIn = marginLeft / pixelsPerInchWidth;
            const marginRightIn = marginRight / pixelsPerInchWidth;

            // Calculate usable area in inches
            const usableWidthIn = pageWidthInInches - marginLeftIn - marginRightIn;
            const usableHeightIn = pageHeightInInches - marginTopIn - marginBottomIn;

            const showDimensions = showMarginDimensionsCheckbox.checked;

            // Margin labels are positioned absolutely relative to templatePage, not contentArea
            // Top margin label - show usable width in the top margin area
            if (showDimensions && marginTop >= 20) {
                marginLabelTop.textContent = `${usableWidthIn.toFixed(2)}"`;
                marginLabelTop.style.display = 'block';
                marginLabelTop.style.top = (offsetY + marginTop / 2) + 'px';
                marginLabelTop.style.left = (offsetX + actualPageWidth / 2) + 'px';
            } else {
                marginLabelTop.style.display = 'none';
            }

            // Right margin label - show usable height in the right margin area (vertical)
            if (showDimensions && marginRight >= 20) {
                marginLabelRight.textContent = `${usableHeightIn.toFixed(2)}"`;
                marginLabelRight.style.display = 'block';
                marginLabelRight.style.top = (offsetY + actualPageHeight / 2) + 'px';
                marginLabelRight.style.left = (offsetX + actualPageWidth - marginRight / 2) + 'px';
            } else {
                marginLabelRight.style.display = 'none';
            }

            updateRulers(offsetX, offsetY, selectedPageWidth, selectedPageHeight);
            updateUsableArea();
            updateDebugInfo();
        }
        
        deviceTypeSelect.addEventListener('change', updatePageSizes);
        scaleTypeSelect.addEventListener('change', updatePageSizes);
        templateTypeSelect.addEventListener('change', updateTemplate);
        pageSizeSelect.addEventListener('change', () => {
            applyDefaultMargins();
            updateTemplate();
        });
        bindingTypeSelect.addEventListener('change', updateRecommendation);
        platformSelect.addEventListener('change', updateRecommendation);
        marginTopSelect.addEventListener('change', updateTemplate);
        marginBottomSelect.addEventListener('change', updateTemplate);
        marginLeftSelect.addEventListener('change', updateTemplate);
        marginRightSelect.addEventListener('change', updateTemplate);
        gridSizeSelect.addEventListener('change', updateTemplate);
        overlayGridSelect.addEventListener('change', updateTemplate);
        showRulersCheckbox.addEventListener('change', updateRulers);
        showMarginDimensionsCheckbox.addEventListener('change', updateTemplate);
        
        updatePageSizes();
        updateRecommendation();
        updateUsableArea();
        updateDebugInfo();
    </script>
</body>
</html>